<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="title">Normand PLLC - Content Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #007cba;
            --primary-dark: #005a87;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --dark-color: #1a1a1a;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
            --text-muted: #6c757d;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.16);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Enhanced Header */
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 0;
            box-shadow: var(--shadow-md);
            position: relative;
        }

        header h1 {
            text-align: center;
            font-weight: 300;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        header h1 i {
            font-size: 24px;
        }

        .header-subtitle {
            text-align: center;
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* Login Form - Enhanced */
        .login-form {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
            max-width: 450px;
            margin: 80px auto;
            position: relative;
            overflow: hidden;
        }

        .login-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .login-form h2 {
            margin-bottom: 30px;
            color: var(--dark-color);
            font-weight: 600;
            text-align: center;
        }

        /* Admin Panel Layout */
        .admin-panel {
            background: transparent;
            padding: 0;
        }

        /* Top Controls Bar */
        .controls-bar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-md);
        }

        .page-selector {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 20px;
        }

        .page-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: var(--text-muted);
        }

        .page-info i {
            color: var(--primary-color);
        }

        /* Visual Page Map */
        .page-map {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-sm);
        }

        .page-map-title {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .map-sections {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 5px 0;
        }

        .map-section {
            padding: 8px 12px;
            background: var(--light-bg);
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .map-section.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-dark);
        }

        .map-section.hidden {
            opacity: 0.5;
            text-decoration: line-through;
        }

        /* Language Tabs - Enhanced */
        .language-tabs {
            display: flex;
            margin-bottom: 25px;
            background: white;
            border-radius: 12px;
            padding: 5px;
            box-shadow: var(--shadow-sm);
        }

        .language-tab {
            flex: 1;
            padding: 12px 20px;
            background: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-muted);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .language-tab:hover {
            background: var(--light-bg);
        }

        .language-tab.active {
            background: var(--primary-color);
            color: white;
            font-weight: 500;
        }

        /* Search Container - Enhanced */
        .search-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-sm);
        }

        .search-wrapper {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 14px 45px 14px 20px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0,124,186,0.1);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .search-results {
            margin-top: 12px;
            padding: 10px;
            background: var(--light-bg);
            border-radius: 6px;
            font-size: 13px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Enhanced Section Cards */
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .section-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
        }

        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .section-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
        }

        .section-card.section-disabled::before {
            background: var(--danger-color);
        }

        .section-card.section-disabled {
            opacity: 0.85;
        }

        /* Section Header with Context */
        .section-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-bottom: 1px solid var(--border-color);
        }

        .section-meta {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .section-title-group {
            flex-grow: 1;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .section-location {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .visibility-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .visibility-badge.visible {
            background: #d4edda;
            color: #155724;
        }

        .visibility-badge.hidden {
            background: #f8d7da;
            color: #721c24;
        }

        /* Toggle Switch - Enhanced */
        .toggle-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 54px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input:checked + .slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Content Fields - Enhanced */
        .section-content {
            padding: 20px;
        }

        .content-field {
            margin-bottom: 25px;
            position: relative;
        }

        .field-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .field-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .field-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .field-description {
            font-size: 11px;
            color: var(--text-muted);
            font-style: italic;
            margin-bottom: 5px;
        }

        .char-counter {
            font-size: 11px;
            color: var(--text-muted);
        }

        .char-counter.warning {
            color: var(--warning-color);
        }

        .char-counter.error {
            color: var(--danger-color);
        }

        .tooltip-icon {
            width: 16px;
            height: 16px;
            background: var(--light-bg);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--text-muted);
            cursor: help;
            position: relative;
        }

        .tooltip-icon:hover .tooltip-content {
            display: block;
        }

        .tooltip-content {
            display: none;
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-color);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            max-width: 250px;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }

        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--dark-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0,124,186,0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* HTML Preview - Enhanced */
        .html-preview {
            margin-top: 12px;
            padding: 16px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            line-height: 1.6;
            color: var(--dark-color);
            position: relative;
        }

        .html-preview::before {
            content: 'PREVIEW';
            position: absolute;
            top: -10px;
            left: 12px;
            background: white;
            padding: 2px 8px;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            border-radius: 4px;
        }

        .html-preview span {
            color: var(--primary-color);
            font-weight: 600;
            text-decoration: underline;
        }

        /* Rich Text Editor Buttons */
        .editor-toolbar {
            display: flex;
            gap: 5px;
            padding: 8px;
            background: var(--light-bg);
            border: 2px solid var(--border-color);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            flex-wrap: wrap;
        }

        .editor-btn {
            padding: 6px 10px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: var(--dark-color);
            transition: all 0.2s;
        }

        .editor-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .editor-btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* Action Buttons - Enhanced */
        .section-actions {
            padding: 20px;
            background: var(--light-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
        }

        /* Image Upload Styles */
        .image-manager {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .image-card {
            position: relative;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .image-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .image-preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .image-info {
            padding: 10px;
            font-size: 12px;
        }

        .image-actions {
            display: flex;
            gap: 5px;
            padding: 10px;
            border-top: 1px solid #eee;
        }

        .upload-zone {
            border: 2px dashed #007cba;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f0f8ff;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-zone:hover {
            background: #e6f3ff;
            border-color: #005a87;
        }

        .upload-zone.dragover {
            background: #e0efff;
            border-color: #0056b3;
        }

        .upload-icon {
            font-size: 48px;
            color: #007cba;
            margin-bottom: 10px;
        }

        .btn-replace-image {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            flex: 1;
        }

        .btn-replace-image:hover {
            background: #138496;
        }

        .image-status {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 3px 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 4px;
            font-size: 11px;
        }

        .image-dimensions {
            color: #6c757d;
            font-size: 11px;
            margin-top: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0;
            transition: width 0.3s ease;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            opacity: 0.8;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        /* RTL Support */
        [dir="rtl"] .section-header {
            text-align: right;
        }

        [dir="rtl"] .section-actions {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .language-tab {
            margin-left: 5px;
            margin-right: 0;
        }

        [dir="rtl"] .images-grid {
            direction: rtl;
        }

        [dir="rtl"] .image-card {
            text-align: right;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--dark-color);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--light-bg);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Status Messages - Enhanced */
        .status {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s;
            position: relative;
            padding-left: 45px;
        }

        .status::before {
            content: '';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: white;
        }

        .status.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-left: 4px solid var(--success-color);
        }

        .status.success::before {
            content: '\f00c';
            background: var(--success-color);
        }

        .status.error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-left: 4px solid var(--danger-color);
        }

        .status.error::before {
            content: '\f00d';
            background: var(--danger-color);
        }

        /* Loading State - Enhanced */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Logout Button - Enhanced */
        .logout {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s;
        }

        .logout:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Section Templates */
        .template-selector {
            margin-bottom: 15px;
        }

        .template-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .template-chip {
            padding: 6px 12px;
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-chip:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .sections-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .page-selector {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .map-sections {
                flex-wrap: wrap;
            }

            .language-tabs {
                flex-direction: column;
            }

            .sections-grid {
                gap: 15px;
            }
        }

        .hidden {
            display: none;
        }

        .section-card.search-hidden {
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1><i class="fas fa-edit"></i> Normand PLLC Content Management System</h1>
            <div class="header-subtitle">Professional Content Editor for Law Firm Website</div>
            <button class="logout hidden" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </header>

    <div class="container">
        <!-- Login Form -->
        <div id="loginForm" class="login-form">
            <h2><i class="fas fa-lock"></i> Admin Login</h2>
            <div class="status" id="loginStatus"></div>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" required placeholder="Enter admin password">
                </div>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="admin-panel hidden">
            <div class="status" id="adminStatus"></div>

            <!-- Controls Bar -->
            <div class="controls-bar">
                <div class="page-selector">
                    <div>
                        <label for="pageSelect">Select Page:</label>
                        <select id="pageSelect" onchange="loadPageSections()">
                            <option value="">Choose a page to edit...</option>
                        </select>
                    </div>
                    <div class="page-info" id="currentFile"></div>
                    <div id="saveAllBtn" class="hidden">
                        <button class="btn-primary" onclick="saveAllSections()">
                            <i class="fas fa-save"></i> Save All Changes
                        </button>
                    </div>
                </div>
            </div>

            <!-- Visual Page Map -->
            <div id="pageMap" class="page-map hidden">
                <div class="page-map-title">Page Structure Overview</div>
                <div class="map-sections" id="mapSections"></div>
            </div>

            <!-- Language Tabs -->
            <div class="language-tabs" id="languageTabs"></div>

            <!-- Search Container -->
            <div id="searchContainer" class="search-container hidden">
                <label for="searchInput">Search & Filter Content:</label>
                <div class="search-wrapper">
                    <input type="text" id="searchInput" class="search-input"
                           placeholder="Type to search sections, titles, or content..."
                           oninput="searchSections()">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div id="searchResults" class="search-results">
                    <i class="fas fa-info-circle"></i>
                    <span>Ready to search</span>
                </div>
            </div>

            <!-- Sections Grid -->
            <div id="sectionsContainer" class="sections-grid hidden"></div>
        </div>

        <div id="loading" class="loading hidden">
            <div class="loading-spinner"></div>
            Loading content...
        </div>
    </div>

    <script>
        let currentToken = localStorage.getItem('admin_token');
        let currentLang = 'en';
        let currentPage = '';
        let languages = {};
        let pages = {};
        let sections = [];
        let unsavedChanges = false;

        // Translation object
        const translations = {
            'en': {
                // Header
                'title': 'Normand PLLC - Content Management System',
                'subtitle': 'Manage your website content safely',
                'login': 'Login',
                'password': 'Password',
                'loginButton': 'Access Admin Panel',
                'logout': 'Logout',
                // Navigation
                'choosePage': 'Choose a page to edit...',
                'currentFile': 'Editing:',
                'searchPlaceholder': 'Search sections...',
                // Actions
                'saveChanges': 'Save Changes',
                'reset': 'Reset',
                'preview': 'Preview',
                'images': 'Images',
                'saveAll': 'Save All Sections',
                // Image Manager
                'imageManager': 'Image Manager',
                'uploadTitle': 'Click to upload or drag and drop',
                'uploadSubtitle': 'PNG, JPG, GIF, WEBP up to 10MB',
                'warningText': 'Important: Images must match original dimensions to preserve animations',
                'replace': 'Replace',
                'uploading': 'Uploading...',
                'uploadSuccess': 'Upload successful!',
                'uploadFailed': 'Upload failed',
                'dimensions': 'dimensions',
                'location': 'Location:',
                'noImages': 'No images found on this page',
                // Messages
                'unsavedChanges': 'You have unsaved changes. Switch language anyway?',
                'resetConfirm': 'Reset all changes in this section?',
                'loginRequired': 'Please enter password',
                'invalidPassword': 'Invalid password',
                'loginSuccess': 'Login successful!',
                'loginFailed': 'Login failed',
                // Status
                'visible': 'LIVE',
                'hidden': 'HIDDEN',
                // Hints and tooltips
                'pageSelectHint': 'Select which page of your website to edit',
                'languageHint': 'Switch between English and Hebrew versions',
                'saveAllHint': 'Save all changes made to all sections at once',
                'searchHint': 'Find specific sections by typing keywords',
                'visibilityHint': 'Toggle whether this section appears on your website',
                'sectionSafetyHint': 'Changes preserve all animations and layouts',
                'backupHint': 'Automatic backup created before each change',
                'previewHint': 'See how this section will look on your website',
                'resetHint': 'Undo all unsaved changes to this section',
                'imageManagerHint': 'Safely replace images without breaking animations',
                'uploadSafetyHint': 'Only image sources change - all animations stay intact',
                'dimensionHint': 'New images should match original dimensions for best results',
                'formatHint': 'Supports JPG, PNG, GIF, WEBP formats up to 10MB',
                'autoOptimizeHint': 'Images are automatically optimized for web performance',
                'dragDropHint': 'You can also drag and drop images directly here',
                'replaceHint': 'Replace this image while keeping all animations',
                'currentFileHint': 'Currently editing this file - changes will be saved here'
            },
            'he': {
                // Header
                'title': '专 注" - 注专转  转',
                'subtitle': ' 转 转 转专 砖 ',
                'login': '转专转',
                'password': '住住',
                'loginButton': '住 驻 ',
                'logout': '转转拽转',
                // Navigation
                'choosePage': '专 注 注专...',
                'currentFile': '注专:',
                'searchPlaceholder': '驻砖 拽注...',
                // Actions
                'saveChanges': '砖专 砖',
                'reset': '驻住',
                'preview': '转爪 拽',
                'images': '转转',
                'saveAll': '砖专 转  拽注',
                // Image Manager
                'imageManager': ' 转转',
                'uploadTitle': '抓 注  专专 砖专专',
                'uploadSubtitle': 'PNG, JPG, GIF, WEBP 注 10MB',
                'warningText': '砖: 转转 转 转 转 拽专转  砖专 爪转',
                'replace': '祝',
                'uploading': '注...',
                'uploadSuccess': '注 爪!',
                'uploadFailed': '注 砖',
                'dimensions': '转',
                'location': '拽:',
                'noImages': ' 爪 转转 注 ',
                // Messages
                'unsavedChanges': '砖  砖 砖 砖专. 祝 砖驻  转?',
                'resetConfirm': '驻住 转  砖 拽注 ?',
                'loginRequired': '  住住',
                'invalidPassword': '住住 砖',
                'loginSuccess': '转专转 爪!',
                'loginFailed': '转专转 砖',
                // Status
                'visible': '驻注',
                'hidden': '住转专',
                // Hints and tooltips
                'pageSelectHint': '专  注 转专 砖 注专',
                'languageHint': '祝  专住转 注专转 转',
                'saveAllHint': '砖专 转  砖 砖爪注  拽注 转 转',
                'searchHint': '爪 拽注 住驻爪驻 注  拽转 转 驻转',
                'visibilityHint': '祝  拽注  驻注 转专 砖',
                'sectionSafetyHint': '砖 砖专 转  爪转 驻专住转',
                'backupHint': '  爪专 驻  砖',
                'previewHint': '专  拽注  专 转专 砖',
                'resetHint': ' 转  砖 砖 砖专 拽注 ',
                'imageManagerHint': '祝 转转   砖专 爪转',
                'uploadSafetyHint': '专拽 拽专转 转转 砖转 -  爪转 砖专转 砖转',
                'dimensionHint': '转转 砖转 爪专转 转 转 拽专转 转爪转 转 转专',
                'formatHint': '转 驻专 JPG, PNG, GIF, WEBP 注 10MB',
                'autoOptimizeHint': '转转 转转 转 爪注 专',
                'dragDropHint': '转   专专 砖 转转 砖专转 ',
                'replaceHint': '祝 转 转  转 砖专 注  爪转',
                'currentFileHint': '专注 注专 转 拽抓  - 砖 砖专 '
            }
        };

        // Translation helper function
        function t(key) {
            return translations[currentLang][key] || translations['en'][key] || key;
        }

        // Tooltip helper function
        function addTooltip(element, hintKey) {
            if (!element) return;

            const tooltipIcon = document.createElement('span');
            tooltipIcon.className = 'tooltip-icon';
            tooltipIcon.innerHTML = '?';
            tooltipIcon.title = t(hintKey);

            const tooltipContent = document.createElement('div');
            tooltipContent.className = 'tooltip-content';
            tooltipContent.textContent = t(hintKey);

            tooltipIcon.appendChild(tooltipContent);
            element.appendChild(tooltipIcon);

            return tooltipIcon;
        }

        // Update all tooltips when language changes
        function updateTooltips() {
            document.querySelectorAll('.tooltip-icon').forEach(icon => {
                const hintKey = icon.dataset.hintKey;
                if (hintKey) {
                    icon.title = t(hintKey);
                    const tooltipContent = icon.querySelector('.tooltip-content');
                    if (tooltipContent) {
                        tooltipContent.textContent = t(hintKey);
                    }
                }
            });

            // Update visibility toggle tooltips
            document.querySelectorAll('.toggle-switch').forEach(toggle => {
                toggle.title = t('visibilityHint');
            });
        }

        // Section metadata for better UX
        const SECTION_META = {
            'hero': {
                icon: 'fa-flag',
                location: 'Homepage top banner - First thing visitors see',
                description: 'Main headline and call-to-action'
            },
            'services': {
                icon: 'fa-briefcase',
                location: 'Service offerings section',
                description: 'List of legal services provided'
            },
            'about': {
                icon: 'fa-users',
                location: 'About us section',
                description: 'Firm introduction and credentials'
            },
            'contact': {
                icon: 'fa-envelope',
                location: 'Contact information section',
                description: 'How clients can reach you'
            },
            'testimonials': {
                icon: 'fa-quote-left',
                location: 'Client testimonials section',
                description: 'Client reviews and success stories'
            },
            'cta': {
                icon: 'fa-bullhorn',
                location: 'Call-to-action sections',
                description: 'Buttons and links to drive conversions'
            }
        };

        // Field metadata for context
        const FIELD_META = {
            'title': {
                label: 'Main Headline',
                description: 'Primary text that grabs attention',
                placeholder: 'e.g., Leading Class Action Law Firm',
                maxLength: 60,
                tooltip: 'Keep under 60 characters for optimal display'
            },
            'subtitle': {
                label: 'Supporting Text',
                description: 'Secondary message below the headline',
                placeholder: 'e.g., Fighting for your rights since 1985',
                maxLength: 120,
                tooltip: 'Provides context to the main headline'
            },
            'content': {
                label: 'Body Content',
                description: 'Main text content',
                placeholder: 'Detailed description...',
                maxLength: 500,
                tooltip: 'Main content area - be clear and concise'
            },
            'buttonText': {
                label: 'Button Label',
                description: 'Call-to-action button text',
                placeholder: 'e.g., Get Free Consultation',
                maxLength: 30,
                tooltip: 'Action-oriented text for buttons'
            },
            'buttonUrl': {
                label: 'Button Link',
                description: 'Where the button leads to',
                placeholder: 'e.g., /contact or #contact-form',
                tooltip: 'Use relative URLs for internal pages'
            }
        };

        // Initialize
        if (currentToken) {
            showAdminPanel();
        } else {
            showLoginForm();
        }

        function showStatus(elementId, message, type = 'success') {
            const status = document.getElementById(elementId);
            status.innerHTML = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        function showLoading(show = true) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        async function login(event) {
            event.preventDefault();
            const password = document.getElementById('password').value;

            try {
                showLoading(true);
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();
                showLoading(false);

                if (data.success) {
                    currentToken = data.token;
                    localStorage.setItem('admin_token', currentToken);
                    showAdminPanel();
                } else {
                    showStatus('loginStatus', data.error || 'Login failed', 'error');
                }
            } catch (error) {
                showLoading(false);
                showStatus('loginStatus', 'Network error occurred', 'error');
            }
        }

        function logout() {
            if (unsavedChanges) {
                if (!confirm('You have unsaved changes. Are you sure you want to logout?')) {
                    return;
                }
            }
            currentToken = null;
            localStorage.removeItem('admin_token');
            showLoginForm();
        }

        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.querySelector('.logout').classList.add('hidden');
        }

        async function showAdminPanel() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            document.querySelector('.logout').classList.remove('hidden');

            await loadLanguages();
            await loadPages();
        }

        async function loadLanguages() {
            try {
                const response = await fetch('/api/admin/languages', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    languages = await response.json();
                    renderLanguageTabs();
                } else {
                    throw new Error('Failed to load languages');
                }
            } catch (error) {
                showStatus('adminStatus', 'Failed to load languages', 'error');
            }
        }

        async function loadPages() {
            try {
                showLoading(true);
                const response = await fetch('/api/admin/pages', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    pages = data.pages;
                    languages = data.languages;
                    renderPageSelector();
                    renderLanguageTabs();
                } else {
                    throw new Error('Failed to load pages');
                }
            } catch (error) {
                showStatus('adminStatus', 'Failed to load pages', 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderPageSelector() {
            const select = document.getElementById('pageSelect');
            select.innerHTML = '<option value="">Choose a page to edit...</option>';

            Object.keys(pages).forEach(pageName => {
                const option = document.createElement('option');
                option.value = pageName;
                option.textContent = pageName === 'index' ? ' Homepage' : ` ${pageName}`;
                select.appendChild(option);
            });

            // Initialize tooltips after UI is rendered
            initializeTooltips();
        }

        function initializeTooltips() {
            // Remove existing tooltips to avoid duplicates
            document.querySelectorAll('.tooltip-icon').forEach(icon => icon.remove());

            // Add tooltips to key UI elements
            const pageSelector = document.querySelector('.page-selector');
            const pageLabel = pageSelector?.querySelector('label[for="pageSelect"]');
            if (pageLabel) {
                const icon = addTooltip(pageLabel, 'pageSelectHint');
                if (icon) icon.dataset.hintKey = 'pageSelectHint';
            }

            const searchContainer = document.getElementById('searchContainer');
            const searchLabel = searchContainer?.querySelector('label[for="searchInput"]');
            if (searchLabel) {
                const icon = addTooltip(searchLabel, 'searchHint');
                if (icon) icon.dataset.hintKey = 'searchHint';
            }

            const saveAllBtn = document.getElementById('saveAllBtn');
            if (saveAllBtn) {
                const icon = addTooltip(saveAllBtn, 'saveAllHint');
                if (icon) icon.dataset.hintKey = 'saveAllHint';
            }

            // Add tooltips to language tabs
            const languageTabs = document.getElementById('languageTabs');
            if (languageTabs) {
                const icon = addTooltip(languageTabs, 'languageHint');
                if (icon) icon.dataset.hintKey = 'languageHint';
            }

            // Add tooltips to current file info
            const currentFileInfo = document.getElementById('currentFile');
            if (currentFileInfo && currentFileInfo.textContent.trim()) {
                const icon = addTooltip(currentFileInfo, 'currentFileHint');
                if (icon) icon.dataset.hintKey = 'currentFileHint';
            }
        }

        function renderLanguageTabs() {
            const tabs = document.getElementById('languageTabs');
            tabs.innerHTML = '';

            Object.keys(languages).forEach(lang => {
                const button = document.createElement('button');
                button.className = `language-tab ${lang === currentLang ? 'active' : ''}`;
                button.innerHTML = `<i class="fas fa-globe"></i> ${languages[lang].name}`;
                button.onclick = () => switchLanguage(lang);
                tabs.appendChild(button);
            });
        }

        function renderPageMap() {
            const mapContainer = document.getElementById('mapSections');
            mapContainer.innerHTML = '';

            sections.forEach((section, index) => {
                const mapItem = document.createElement('div');
                mapItem.className = `map-section ${section.visible ? '' : 'hidden'}`;
                mapItem.textContent = section.name;
                mapItem.onclick = () => scrollToSection(section.id);

                mapContainer.appendChild(mapItem);
            });

            document.getElementById('pageMap').classList.remove('hidden');
        }

        function scrollToSection(sectionId) {
            const element = document.getElementById(`section-${sectionId}`);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                element.style.animation = 'pulse 1s';
                setTimeout(() => {
                    element.style.animation = '';
                }, 1000);
            }
        }

        function switchLanguage(lang) {
            if (unsavedChanges) {
                if (!confirm(t('unsavedChanges'))) {
                    return;
                }
            }
            currentLang = lang;
            unsavedChanges = false;

            // Update UI language
            updateUILanguage();
            renderLanguageTabs();
            if (currentPage) {
                loadPageSections();
            }
        }

        // Update UI elements with current language
        function updateUILanguage() {
            // Update title
            document.title = t('title');

            // Update main header
            const headerTitle = document.querySelector('header h1');
            if (headerTitle) {
                headerTitle.innerHTML = `<i class="fas fa-cog"></i> ${t('title')}`;
            }

            const headerSubtitle = document.querySelector('.header-subtitle');
            if (headerSubtitle) {
                headerSubtitle.textContent = t('subtitle');
            }

            // Update placeholders and buttons
            const pageSelect = document.getElementById('pageSelect');
            if (pageSelect && pageSelect.options[0]) {
                pageSelect.options[0].text = t('choosePage');
            }

            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.placeholder = t('searchPlaceholder');
            }

            const saveAllBtn = document.getElementById('saveAllBtn');
            if (saveAllBtn) {
                saveAllBtn.innerHTML = `<i class="fas fa-save"></i> ${t('saveAll')}`;
            }

            // Set HTML direction for Hebrew
            document.documentElement.dir = currentLang === 'he' ? 'rtl' : 'ltr';
            document.documentElement.lang = currentLang;

            // Update all tooltips
            updateTooltips();
        }

        async function loadPageSections() {
            const pageName = document.getElementById('pageSelect').value;
            if (!pageName) {
                document.getElementById('sectionsContainer').classList.add('hidden');
                document.getElementById('searchContainer').classList.add('hidden');
                document.getElementById('pageMap').classList.add('hidden');
                document.getElementById('currentFile').innerHTML = '';
                return;
            }

            currentPage = pageName;
            await loadSections();
        }

        async function loadSections() {
            if (!currentPage || !currentLang) return;

            try {
                showLoading(true);
                const response = await fetch(`/api/admin/sections/${currentLang}/${currentPage}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    sections = data.sections;
                    unsavedChanges = false;

                    document.getElementById('currentFile').innerHTML = `
                        <i class="fas fa-file-alt"></i>
                        Editing: <strong>${data.filename}</strong>
                    `;

                    renderSections();
                    renderPageMap();
                    document.getElementById('sectionsContainer').classList.remove('hidden');
                    document.getElementById('searchContainer').classList.remove('hidden');
                    document.getElementById('saveAllBtn').classList.remove('hidden');

                    // Clear search
                    document.getElementById('searchInput').value = '';
                    updateSearchResults(sections.length, sections.length);
                } else if (response.status === 404) {
                    showStatus('adminStatus',
                        `<i class="fas fa-exclamation-triangle"></i> ${languages[currentLang].name} version not found for this page`,
                        'error');
                    document.getElementById('sectionsContainer').classList.add('hidden');
                    document.getElementById('searchContainer').classList.add('hidden');
                    document.getElementById('pageMap').classList.add('hidden');
                } else {
                    throw new Error('Failed to load sections');
                }
            } catch (error) {
                showStatus('adminStatus', 'Failed to load sections', 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderSections() {
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = '';

            sections.forEach(section => {
                const sectionCard = createSectionCard(section);
                container.appendChild(sectionCard);
            });
        }

        function createSectionCard(section) {
            const card = document.createElement('div');
            card.className = `section-card ${section.visible ? '' : 'section-disabled'}`;
            card.id = `section-${section.id}`;

            // Get section metadata
            const meta = SECTION_META[section.id] || {
                icon: 'fa-file',
                location: 'Content section',
                description: 'Website content'
            };

            // Section Header
            const header = document.createElement('div');
            header.className = 'section-header';
            header.innerHTML = `
                <div class="section-meta">
                    <div class="section-title-group">
                        <div class="section-title">
                            <div class="section-icon">
                                <i class="fas ${meta.icon}"></i>
                            </div>
                            <span>${section.name}</span>
                        </div>
                        <div class="section-location">
                            <i class="fas fa-map-marker-alt"></i>
                            ${meta.location}
                        </div>
                    </div>
                    <div class="toggle-section">
                        <span class="visibility-badge ${section.visible ? 'visible' : 'hidden'}">
                            ${section.visible ? t('visible') : t('hidden')}
                        </span>
                        <label class="toggle-switch" title="${t('visibilityHint')}">
                            <input type="checkbox" ${section.visible ? 'checked' : ''}
                                   onchange="toggleSection('${section.id}', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            `;

            // Content Fields
            const content = document.createElement('div');
            content.className = 'section-content';

            // Template selector (if applicable)
            if (section.id === 'hero' || section.id === 'cta') {
                const templateDiv = document.createElement('div');
                templateDiv.className = 'template-selector';
                templateDiv.innerHTML = `
                    <label>Quick Templates:</label>
                    <div class="template-chips">
                        <div class="template-chip" onclick="applyTemplate('${section.id}', 'professional')">
                            Professional
                        </div>
                        <div class="template-chip" onclick="applyTemplate('${section.id}', 'aggressive')">
                            Aggressive
                        </div>
                        <div class="template-chip" onclick="applyTemplate('${section.id}', 'friendly')">
                            Client-Friendly
                        </div>
                    </div>
                `;
                content.appendChild(templateDiv);
            }

            // Create form fields
            Object.keys(section.content).forEach(key => {
                const field = createEnhancedField(section, key);
                content.appendChild(field);
            });

            // Actions
            const actions = document.createElement('div');
            actions.className = 'section-actions';

            // Create buttons with tooltips
            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn-primary';
            saveBtn.onclick = () => saveSection(section.id);
            saveBtn.innerHTML = `<i class="fas fa-save"></i> ${t('saveChanges')}`;
            const saveIcon = addTooltip(saveBtn, 'sectionSafetyHint');
            if (saveIcon) saveIcon.dataset.hintKey = 'sectionSafetyHint';

            const resetBtn = document.createElement('button');
            resetBtn.className = 'btn-secondary';
            resetBtn.onclick = () => resetSection(section.id);
            resetBtn.innerHTML = `<i class="fas fa-undo"></i> ${t('reset')}`;
            const resetIcon = addTooltip(resetBtn, 'resetHint');
            if (resetIcon) resetIcon.dataset.hintKey = 'resetHint';

            const previewBtn = document.createElement('button');
            previewBtn.className = 'btn-secondary';
            previewBtn.onclick = () => previewSection(section.id);
            previewBtn.innerHTML = `<i class="fas fa-eye"></i> ${t('preview')}`;
            const previewIcon = addTooltip(previewBtn, 'previewHint');
            if (previewIcon) previewIcon.dataset.hintKey = 'previewHint';

            const imagesBtn = document.createElement('button');
            imagesBtn.className = 'btn-secondary';
            imagesBtn.onclick = () => manageImages(section.id);
            imagesBtn.innerHTML = `<i class="fas fa-image"></i> ${t('images')}`;
            const imagesIcon = addTooltip(imagesBtn, 'imageManagerHint');
            if (imagesIcon) imagesIcon.dataset.hintKey = 'imageManagerHint';

            actions.appendChild(saveBtn);
            actions.appendChild(resetBtn);
            actions.appendChild(previewBtn);
            actions.appendChild(imagesBtn);

            card.appendChild(header);
            card.appendChild(content);
            card.appendChild(actions);

            return card;
        }

        function createEnhancedField(section, key) {
            const field = document.createElement('div');
            field.className = 'content-field';

            const value = section.content[key] || '';
            const meta = FIELD_META[key] || {
                label: key.replace(/([A-Z])/g, ' $1').trim(),
                description: '',
                placeholder: '',
                maxLength: 500
            };

            const hasHTML = /<[^>]+>/.test(value);
            const isLongText = value.length > 100 || key.includes('content') || key.includes('description');

            // Field header with label and info
            const fieldHeader = document.createElement('div');
            fieldHeader.className = 'field-header';
            fieldHeader.innerHTML = `
                <div class="field-label">
                    ${meta.label}
                    ${meta.tooltip ? `
                        <div class="tooltip-icon">
                            <i class="fas fa-info"></i>
                            <div class="tooltip-content">${meta.tooltip}</div>
                        </div>
                    ` : ''}
                </div>
                <div class="field-info">
                    <span class="char-counter" id="counter-${section.id}-${key}">
                        0 / ${meta.maxLength}
                    </span>
                </div>
            `;

            // Field description
            if (meta.description) {
                const desc = document.createElement('div');
                desc.className = 'field-description';
                desc.textContent = meta.description;
                field.appendChild(desc);
            }

            field.appendChild(fieldHeader);

            // Rich text editor for HTML content
            if (hasHTML) {
                const toolbar = document.createElement('div');
                toolbar.className = 'editor-toolbar';
                toolbar.innerHTML = `
                    <button type="button" class="editor-btn" onclick="formatText('${section.id}-${key}', 'bold')">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button type="button" class="editor-btn" onclick="formatText('${section.id}-${key}', 'italic')">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button type="button" class="editor-btn" onclick="formatText('${section.id}-${key}', 'underline')">
                        <i class="fas fa-underline"></i>
                    </button>
                    <button type="button" class="editor-btn" onclick="addLink('${section.id}-${key}')">
                        <i class="fas fa-link"></i>
                    </button>
                    <button type="button" class="editor-btn" onclick="clearFormat('${section.id}-${key}')">
                        <i class="fas fa-remove-format"></i>
                    </button>
                `;
                field.appendChild(toolbar);
            }

            // Input field
            const input = document.createElement(isLongText ? 'textarea' : 'input');
            input.type = isLongText ? undefined : 'text';
            input.value = value;
            input.id = `${section.id}-${key}`;
            input.placeholder = meta.placeholder;
            input.maxLength = meta.maxLength;

            // Add input listeners
            input.addEventListener('input', (e) => {
                updateCharCounter(section.id, key, e.target.value.length, meta.maxLength);
                markAsUnsaved();

                // Update preview if exists
                const preview = document.getElementById(`${section.id}-${key}-preview`);
                if (preview) {
                    preview.innerHTML = e.target.value;
                }
            });

            // Add styles for HTML input
            if (hasHTML && !isLongText) {
                input.style.borderRadius = '0 0 8px 8px';
            }

            field.appendChild(input);

            // HTML preview
            if (hasHTML) {
                const preview = document.createElement('div');
                preview.className = 'html-preview';
                preview.id = `${section.id}-${key}-preview`;
                preview.innerHTML = value;
                field.appendChild(preview);
            }

            // Update initial counter
            setTimeout(() => {
                updateCharCounter(section.id, key, value.length, meta.maxLength);
            }, 0);

            return field;
        }

        function updateCharCounter(sectionId, key, length, maxLength) {
            const counter = document.getElementById(`counter-${sectionId}-${key}`);
            if (counter) {
                counter.textContent = `${length} / ${maxLength}`;
                counter.className = 'char-counter';

                if (length > maxLength) {
                    counter.classList.add('error');
                } else if (length > maxLength * 0.9) {
                    counter.classList.add('warning');
                }
            }
        }

        function markAsUnsaved() {
            unsavedChanges = true;
            const saveBtn = document.querySelector('#saveAllBtn button');
            if (saveBtn) {
                saveBtn.style.animation = 'pulse 1s infinite';
            }
        }

        function formatText(fieldId, command) {
            const field = document.getElementById(fieldId);
            const start = field.selectionStart;
            const end = field.selectionEnd;
            const text = field.value;
            const selectedText = text.substring(start, end);

            let newText = '';
            switch(command) {
                case 'bold':
                    newText = `<strong>${selectedText}</strong>`;
                    break;
                case 'italic':
                    newText = `<em>${selectedText}</em>`;
                    break;
                case 'underline':
                    newText = `<span style="text-decoration: underline">${selectedText}</span>`;
                    break;
            }

            field.value = text.substring(0, start) + newText + text.substring(end);
            field.dispatchEvent(new Event('input'));
        }

        function addLink(fieldId) {
            const url = prompt('Enter URL:');
            if (url) {
                formatText(fieldId, 'link', url);
            }
        }

        function clearFormat(fieldId) {
            const field = document.getElementById(fieldId);
            field.value = field.value.replace(/<[^>]*>/g, '');
            field.dispatchEvent(new Event('input'));
        }

        function applyTemplate(sectionId, template) {
            const templates = {
                'professional': {
                    'title': 'Expert Legal Representation',
                    'subtitle': 'Trusted by thousands of clients nationwide',
                    'buttonText': 'Schedule Consultation'
                },
                'aggressive': {
                    'title': 'We Fight to Win',
                    'subtitle': 'Maximum compensation for your case',
                    'buttonText': 'Start Your Case Now'
                },
                'friendly': {
                    'title': 'Your Legal Partners',
                    'subtitle': 'Compassionate support through every step',
                    'buttonText': 'Let\'s Talk'
                }
            };

            const section = sections.find(s => s.id === sectionId);
            if (section && templates[template]) {
                Object.keys(templates[template]).forEach(key => {
                    const field = document.getElementById(`${sectionId}-${key}`);
                    if (field) {
                        field.value = templates[template][key];
                        field.dispatchEvent(new Event('input'));
                    }
                });
                showStatus('adminStatus', `Template "${template}" applied successfully`);
            }
        }

        async function toggleSection(sectionId, visible) {
            try {
                const response = await fetch(`/api/admin/section/${currentLang}/${currentPage}/${sectionId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ visible })
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus('adminStatus',
                        `<i class="fas fa-check-circle"></i> Section ${visible ? 'published' : 'hidden'} successfully!`);

                    // Update UI
                    const card = document.getElementById(`section-${sectionId}`);
                    const badge = card.querySelector('.visibility-badge');

                    if (visible) {
                        card.classList.remove('section-disabled');
                        badge.textContent = 'LIVE';
                        badge.className = 'visibility-badge visible';
                    } else {
                        card.classList.add('section-disabled');
                        badge.textContent = 'HIDDEN';
                        badge.className = 'visibility-badge hidden';
                    }

                    // Update local data
                    const sectionIndex = sections.findIndex(s => s.id === sectionId);
                    if (sectionIndex !== -1) {
                        sections[sectionIndex].visible = visible;
                    }

                    // Update page map
                    renderPageMap();
                } else {
                    showStatus('adminStatus', result.error || 'Failed to toggle section', 'error');
                    // Revert checkbox
                    const checkbox = document.querySelector(`#section-${sectionId} input[type="checkbox"]`);
                    checkbox.checked = !visible;
                }
            } catch (error) {
                showStatus('adminStatus', 'Network error occurred', 'error');
                // Revert checkbox
                const checkbox = document.querySelector(`#section-${sectionId} input[type="checkbox"]`);
                checkbox.checked = !visible;
            }
        }

        async function saveSection(sectionId) {
            try {
                const content = {};
                const section = sections.find(s => s.id === sectionId);

                if (!section) {
                    showStatus('adminStatus', 'Section not found', 'error');
                    return;
                }

                // Collect content
                Object.keys(section.content).forEach(key => {
                    const input = document.getElementById(`${sectionId}-${key}`);
                    if (input) {
                        content[key] = input.value;
                    }
                });

                showLoading(true);
                const response = await fetch(`/api/admin/section/${currentLang}/${currentPage}/${sectionId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });

                const result = await response.json();
                showLoading(false);

                if (response.ok) {
                    showStatus('adminStatus',
                        `<i class="fas fa-check-circle"></i> ${result.message || 'Section saved successfully!'}`);

                    // Update local data
                    const sectionIndex = sections.findIndex(s => s.id === sectionId);
                    if (sectionIndex !== -1) {
                        sections[sectionIndex].content = { ...sections[sectionIndex].content, ...content };
                    }

                    // Reset unsaved state for this section
                    const saveBtn = document.querySelector('#saveAllBtn button');
                    if (saveBtn) {
                        saveBtn.style.animation = '';
                    }
                } else {
                    showStatus('adminStatus', result.error || 'Failed to save section', 'error');
                }
            } catch (error) {
                showLoading(false);
                showStatus('adminStatus', 'Network error occurred', 'error');
            }
        }

        async function saveAllSections() {
            if (!confirm('Save all changes to this page?')) {
                return;
            }

            let savedCount = 0;
            let failedCount = 0;

            for (const section of sections) {
                try {
                    const content = {};
                    Object.keys(section.content).forEach(key => {
                        const input = document.getElementById(`${section.id}-${key}`);
                        if (input) {
                            content[key] = input.value;
                        }
                    });

                    const response = await fetch(`/api/admin/section/${currentLang}/${currentPage}/${section.id}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${currentToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ content })
                    });

                    if (response.ok) {
                        savedCount++;
                    } else {
                        failedCount++;
                    }
                } catch (error) {
                    failedCount++;
                }
            }

            if (failedCount === 0) {
                showStatus('adminStatus',
                    `<i class="fas fa-check-circle"></i> All ${savedCount} sections saved successfully!`);
                unsavedChanges = false;
            } else {
                showStatus('adminStatus',
                    `Saved ${savedCount} sections, ${failedCount} failed`, 'error');
            }
        }

        function resetSection(sectionId) {
            if (confirm(t('resetConfirm'))) {
                loadSections();
            }
        }

        // Image Management Functions
        async function manageImages(sectionId) {
            const modal = createImageManagerModal(sectionId);
            document.body.appendChild(modal);
            await loadPageImages();
        }

        function createImageManagerModal(sectionId) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'imageManagerModal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; ${currentLang === 'he' ? 'direction: rtl;' : ''}">
                    <div class="modal-header">
                        <h2><i class="fas fa-image"></i> ${t('imageManager')} - ${sectionId}</h2>
                        <button class="modal-close" onclick="closeImageManager()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('imageUpload').click()">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div>
                                <h3 class="upload-title">${t('uploadTitle')}</h3>
                                <p class="upload-subtitle">${t('uploadSubtitle')}</p>
                                <p class="upload-warning" style="color: #dc3545; margin-top: 10px; font-size: 12px;">
                                    锔 <span class="warning-text">${t('warningText')}</span>
                                </p>
                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 12px; margin-top: 10px; font-size: 11px; color: #856404;">
                                    <strong> ${currentLang === 'he' ? '转 砖转:' : 'Important Restrictions:'}</strong><br>
                                     ${currentLang === 'he' ? '砖专 注 转 转 拽专' : 'Keep same dimensions as original'}<br>
                                     ${currentLang === 'he' ? '专拽 拽抓 src 祝 - 爪转 砖专' : 'Only src attribute changes - animations preserved'}<br>
                                     ${currentLang === 'he' ? '  爪专 驻  砖' : 'Auto-backup created before each change'}
                                </div>
                            </div>
                            <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event, '${sectionId}')">
                        </div>
                        <div id="uploadProgress" style="display: none; margin: 20px 0;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <p id="uploadStatus">${t('uploading')}</p>
                        </div>
                        <div class="images-grid" id="imagesGrid">
                            <!-- Images will be loaded here -->
                        </div>
                    </div>
                </div>
            `;

            // Add drag and drop functionality
            const uploadZone = modal.querySelector('#uploadZone');
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageUpload({ target: { files } }, sectionId);
                }
            });

            return modal;
        }

        function closeImageManager() {
            const modal = document.getElementById('imageManagerModal');
            if (modal) {
                modal.remove();
            }
        }

        async function loadPageImages() {
            try {
                const response = await fetch(`/api/admin/images/${currentLang}/${currentPage}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayImages(data.images);
                }
            } catch (error) {
                console.error('Failed to load images:', error);
            }
        }

        function displayImages(images) {
            const grid = document.getElementById('imagesGrid');
            grid.innerHTML = '';

            if (images.length === 0) {
                grid.innerHTML = `<p style="text-align: center; color: #999;">${t('noImages')}</p>`;
                return;
            }

            images.forEach((img, index) => {
                const card = document.createElement('div');
                card.className = 'image-card';
                card.innerHTML = `
                    <img src="${img.src}" class="image-preview" alt="${img.alt || 'Image ' + index}">
                    <div class="image-status">${img.class || 'No class'}</div>
                    <div class="image-info">
                        <strong>${t('location')}</strong> ${img.parentTag} > ${img.class || 'img'}<br>
                        <div class="image-dimensions" id="dimensions-${index}">Loading ${t('dimensions')}...</div>
                    </div>
                    <div class="image-actions">
                        <button class="btn-replace-image" onclick="replaceImage('${img.src}', ${index})">
                            <i class="fas fa-exchange-alt"></i> ${t('replace')}
                        </button>
                    </div>
                `;
                grid.appendChild(card);

                // Load actual dimensions
                const imgElement = new Image();
                imgElement.onload = function() {
                    const dimensionsEl = document.getElementById(`dimensions-${index}`);
                    if (dimensionsEl) {
                        dimensionsEl.textContent = `${this.width}  ${this.height}px`;
                    }
                };
                imgElement.src = img.src;
            });
        }

        async function handleImageUpload(event, sectionId) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showStatus('adminStatus', 'Please upload a valid image file', 'error');
                return;
            }

            // Validate file size (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showStatus('adminStatus', 'File size must be less than 10MB', 'error');
                return;
            }

            // Show progress
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('uploadStatus').textContent = 'Uploading image...';

            const formData = new FormData();
            formData.append('image', file);
            formData.append('page', currentPage);
            formData.append('lang', currentLang);
            formData.append('targetElement', sectionId);

            try {
                const response = await fetch('/api/admin/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('uploadStatus').textContent = t('uploadSuccess');
                    document.getElementById('progressFill').style.width = '100%';

                    // Reload images
                    setTimeout(() => {
                        document.getElementById('uploadProgress').style.display = 'none';
                        loadPageImages();
                    }, 1000);

                    showStatus('adminStatus', t('uploadSuccess'), 'success');
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                document.getElementById('uploadStatus').textContent = t('uploadFailed');
                showStatus('adminStatus', t('uploadFailed'), 'error');
                console.error('Upload error:', error);
            }
        }

        async function replaceImage(oldSrc, index) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('image', file);
                formData.append('page', currentPage);
                formData.append('lang', currentLang);

                try {
                    // First upload the new image
                    const uploadResponse = await fetch('/api/admin/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${currentToken}`
                        },
                        body: formData
                    });

                    if (uploadResponse.ok) {
                        const uploadData = await uploadResponse.json();

                        // Then update the HTML to replace the old image
                        const updateResponse = await fetch('/api/admin/update-image', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${currentToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                page: currentPage,
                                lang: currentLang,
                                oldImageUrl: oldSrc,
                                newImageUrl: uploadData.imageUrl
                            })
                        });

                        if (updateResponse.ok) {
                            showStatus('adminStatus', 'Image replaced successfully', 'success');
                            loadPageImages();
                            // Mark as having unsaved changes
                            unsavedChanges = true;
                        } else {
                            throw new Error('Failed to update HTML');
                        }
                    } else {
                        throw new Error('Failed to upload image');
                    }
                } catch (error) {
                    showStatus('adminStatus', 'Failed to replace image', 'error');
                    console.error('Replace error:', error);
                }
            };
            input.click();
        }

        function previewSection(sectionId) {
            const section = sections.find(s => s.id === sectionId);
            if (section) {
                // Get current content values from form
                const currentContent = {};
                Object.keys(section.content).forEach(key => {
                    const input = document.getElementById(`${sectionId}-${key}`);
                    currentContent[key] = input ? input.value : section.content[key];
                });

                // Open preview in new window
                const previewWindow = window.open('', '_blank', 'width=1400,height=900');

                // Generate visual HTML based on section type
                let sectionHTML = '';

                if (sectionId === 'hero' || sectionId === 'hero-banner') {
                    sectionHTML = `
                        <section class="hero-section">
                            <div class="hero-overlay"></div>
                            <div class="hero-content">
                                <h1 class="hero-title">${currentContent.title || currentContent.heading || 'Hero Title'}</h1>
                                ${currentContent.subtitle || currentContent.subheading ?
                                    `<p class="hero-subtitle">${currentContent.subtitle || currentContent.subheading}</p>` : ''}
                                ${currentContent.description ?
                                    `<p class="hero-description">${currentContent.description}</p>` : ''}
                                ${currentContent.buttonText || currentContent.ctaText ? `
                                    <button class="hero-button">
                                        ${currentContent.buttonText || currentContent.ctaText}
                                    </button>
                                ` : ''}
                                ${currentContent.secondaryButtonText ? `
                                    <button class="hero-button-secondary">
                                        ${currentContent.secondaryButtonText}
                                    </button>
                                ` : ''}
                            </div>
                        </section>
                    `;
                } else if (sectionId === 'services' || sectionId === 'practice-areas') {
                    sectionHTML = `
                        <section class="services-section">
                            <div class="container">
                                <h2>${currentContent.title || 'Our Services'}</h2>
                                ${currentContent.subtitle ? `<p class="section-subtitle">${currentContent.subtitle}</p>` : ''}
                                <div class="services-grid">
                                    ${currentContent.content ? currentContent.content.split('\n').map(item =>
                                        `<div class="service-item">
                                            <i class="fas fa-gavel"></i>
                                            <p>${item}</p>
                                        </div>`
                                    ).join('') : ''}
                                </div>
                            </div>
                        </section>
                    `;
                } else if (sectionId === 'about' || sectionId === 'team' || sectionId === 'team-section' || sectionId === 'our-team') {
                    sectionHTML = `
                        <section class="about-section">
                            <div class="container">
                                ${currentContent.title || currentContent.heading ?
                                    `<h2 class="section-title">${currentContent.title || currentContent.heading}</h2>` : ''}
                                ${currentContent.subtitle || currentContent.subheading ?
                                    `<p class="section-subtitle">${currentContent.subtitle || currentContent.subheading}</p>` : ''}

                                ${currentContent.content || currentContent.description ? `
                                    <div class="about-content">
                                        <p>${currentContent.content || currentContent.description}</p>
                                    </div>
                                ` : ''}

                                ${(currentContent.founderName || currentContent.founder_name ||
                                   currentContent.teamMember1Name || currentContent.member1Name) ? `
                                    <div class="team-grid">
                                        <div class="team-member">
                                            ${currentContent.founderImage || currentContent.founder_image ?
                                                `<img src="${currentContent.founderImage || currentContent.founder_image}" alt="Team member" />` :
                                                '<div class="member-placeholder"><i class="fas fa-user-circle"></i></div>'}
                                            <h3>${currentContent.founderName || currentContent.founder_name ||
                                                 currentContent.teamMember1Name || currentContent.member1Name || 'Team Member'}</h3>
                                            <p class="member-role">${currentContent.founderRole || currentContent.founder_role ||
                                                                     currentContent.teamMember1Role || currentContent.member1Role || 'Position'}</p>
                                            ${currentContent.founderBio || currentContent.founder_bio ||
                                              currentContent.teamMember1Bio || currentContent.member1Bio ?
                                              `<p class="member-bio">${currentContent.founderBio || currentContent.founder_bio ||
                                                                       currentContent.teamMember1Bio || currentContent.member1Bio}</p>` : ''}
                                        </div>

                                        ${(currentContent.teamMember2Name || currentContent.member2Name) ? `
                                            <div class="team-member">
                                                ${currentContent.teamMember2Image || currentContent.member2Image ?
                                                    `<img src="${currentContent.teamMember2Image || currentContent.member2Image}" alt="Team member" />` :
                                                    '<div class="member-placeholder"><i class="fas fa-user-circle"></i></div>'}
                                                <h3>${currentContent.teamMember2Name || currentContent.member2Name}</h3>
                                                <p class="member-role">${currentContent.teamMember2Role || currentContent.member2Role || 'Position'}</p>
                                                ${currentContent.teamMember2Bio || currentContent.member2Bio ?
                                                  `<p class="member-bio">${currentContent.teamMember2Bio || currentContent.member2Bio}</p>` : ''}
                                            </div>
                                        ` : ''}

                                        ${(currentContent.teamMember3Name || currentContent.member3Name) ? `
                                            <div class="team-member">
                                                ${currentContent.teamMember3Image || currentContent.member3Image ?
                                                    `<img src="${currentContent.teamMember3Image || currentContent.member3Image}" alt="Team member" />` :
                                                    '<div class="member-placeholder"><i class="fas fa-user-circle"></i></div>'}
                                                <h3>${currentContent.teamMember3Name || currentContent.member3Name}</h3>
                                                <p class="member-role">${currentContent.teamMember3Role || currentContent.member3Role || 'Position'}</p>
                                                ${currentContent.teamMember3Bio || currentContent.member3Bio ?
                                                  `<p class="member-bio">${currentContent.teamMember3Bio || currentContent.member3Bio}</p>` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </section>
                    `;
                } else if (sectionId === 'contact' || sectionId === 'contact-form') {
                    sectionHTML = `
                        <section class="contact-section">
                            <div class="container">
                                <h2>${currentContent.title || 'Contact Us'}</h2>
                                ${currentContent.subtitle ? `<p class="section-subtitle">${currentContent.subtitle}</p>` : ''}
                                <div class="contact-grid">
                                    <div class="contact-form">
                                        <input type="text" placeholder="Name" />
                                        <input type="email" placeholder="Email" />
                                        <input type="tel" placeholder="Phone" />
                                        <textarea placeholder="Message"></textarea>
                                        <button>${currentContent.buttonText || 'Send Message'}</button>
                                    </div>
                                    <div class="contact-info">
                                        ${currentContent.phone ? `<p><i class="fas fa-phone"></i> ${currentContent.phone}</p>` : ''}
                                        ${currentContent.email ? `<p><i class="fas fa-envelope"></i> ${currentContent.email}</p>` : ''}
                                        ${currentContent.address ? `<p><i class="fas fa-map-marker-alt"></i> ${currentContent.address}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        </section>
                    `;
                } else if (sectionId === 'cta') {
                    sectionHTML = `
                        <section class="cta-section">
                            <div class="container">
                                <h2>${currentContent.title || 'Call to Action'}</h2>
                                ${currentContent.subtitle ? `<p>${currentContent.subtitle}</p>` : ''}
                                ${currentContent.buttonText ? `
                                    <button class="cta-button">${currentContent.buttonText}</button>
                                ` : ''}
                            </div>
                        </section>
                    `;
                } else {
                    // Generic section preview - Display ALL fields
                    let fieldsHTML = '';

                    // Common fields first
                    if (currentContent.title || currentContent.heading) {
                        fieldsHTML += `<h2 class="section-title">${currentContent.title || currentContent.heading}</h2>`;
                    }
                    if (currentContent.subtitle || currentContent.subheading) {
                        fieldsHTML += `<p class="section-subtitle">${currentContent.subtitle || currentContent.subheading}</p>`;
                    }
                    if (currentContent.content || currentContent.description) {
                        fieldsHTML += `<div class="content">${currentContent.content || currentContent.description}</div>`;
                    }

                    // Display ALL other fields in a structured way
                    const processedFields = ['title', 'heading', 'subtitle', 'subheading', 'content', 'description', 'buttonText', 'buttonUrl', 'ctaText'];
                    const remainingFields = Object.keys(currentContent).filter(key => !processedFields.includes(key));

                    if (remainingFields.length > 0) {
                        fieldsHTML += '<div class="additional-fields">';
                        remainingFields.forEach(key => {
                            const value = currentContent[key];
                            if (value && value.toString().trim()) {
                                // Format field name nicely
                                const fieldLabel = key
                                    .replace(/([A-Z])/g, ' $1')
                                    .replace(/_/g, ' ')
                                    .replace(/^./, str => str.toUpperCase())
                                    .trim();

                                // Check if it's an image field
                                if (key.toLowerCase().includes('image') || key.toLowerCase().includes('img') || key.toLowerCase().includes('photo')) {
                                    fieldsHTML += `
                                        <div class="field-item">
                                            <strong>${fieldLabel}:</strong>
                                            <img src="${value}" alt="${fieldLabel}" style="max-width: 200px; margin-top: 10px; display: block;" />
                                        </div>
                                    `;
                                }
                                // Check if it's a URL field
                                else if (key.toLowerCase().includes('url') || key.toLowerCase().includes('link')) {
                                    fieldsHTML += `
                                        <div class="field-item">
                                            <strong>${fieldLabel}:</strong>
                                            <a href="${value}" target="_blank" style="color: #007cba;">${value}</a>
                                        </div>
                                    `;
                                }
                                // Long text (likely bio or description)
                                else if (value.length > 150) {
                                    fieldsHTML += `
                                        <div class="field-item">
                                            <strong>${fieldLabel}:</strong>
                                            <p class="long-text">${value}</p>
                                        </div>
                                    `;
                                }
                                // Short text
                                else {
                                    fieldsHTML += `
                                        <div class="field-item">
                                            <strong>${fieldLabel}:</strong> <span>${value}</span>
                                        </div>
                                    `;
                                }
                            }
                        });
                        fieldsHTML += '</div>';
                    }

                    // Add buttons if they exist
                    if (currentContent.buttonText || currentContent.ctaText) {
                        fieldsHTML += `
                            <div class="buttons-container" style="margin-top: 30px;">
                                <button class="primary-button">${currentContent.buttonText || currentContent.ctaText}</button>
                            </div>
                        `;
                    }

                    sectionHTML = `
                        <section class="generic-section">
                            <div class="container">
                                ${fieldsHTML || '<p style="color: #999; text-align: center;">No content to display</p>'}
                            </div>
                        </section>
                    `;
                }

                previewWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="${currentLang}" ${currentLang === 'he' ? 'dir="rtl"' : ''}>
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>Preview: ${section.name}</title>
                            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                            <style>
                                * {
                                    margin: 0;
                                    padding: 0;
                                    box-sizing: border-box;
                                }

                                body {
                                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
                                    line-height: 1.6;
                                    color: #333;
                                }

                                .preview-header {
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    padding: 15px;
                                    text-align: center;
                                    position: sticky;
                                    top: 0;
                                    z-index: 100;
                                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                                }

                                .preview-header h3 {
                                    font-size: 16px;
                                    font-weight: 500;
                                    margin: 0;
                                }

                                .preview-info {
                                    font-size: 12px;
                                    opacity: 0.9;
                                    margin-top: 4px;
                                }

                                .container {
                                    max-width: 1200px;
                                    margin: 0 auto;
                                    padding: 0 20px;
                                }

                                /* Hero Section Styles */
                                .hero-section {
                                    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
                                    background-image: linear-gradient(135deg, rgba(26, 26, 26, 0.9) 0%, rgba(45, 45, 45, 0.9) 100%),
                                                      url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23333"/><circle cx="50" cy="50" r="40" fill="none" stroke="%23444" stroke-width="0.5"/></svg>');
                                    color: white;
                                    padding: 120px 20px;
                                    text-align: center;
                                    min-height: 600px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    position: relative;
                                    overflow: hidden;
                                }

                                .hero-overlay {
                                    position: absolute;
                                    top: 0;
                                    left: 0;
                                    right: 0;
                                    bottom: 0;
                                    background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.3) 100%);
                                    pointer-events: none;
                                }

                                .hero-content {
                                    max-width: 900px;
                                    position: relative;
                                    z-index: 1;
                                    animation: fadeInUp 1s ease;
                                }

                                @keyframes fadeInUp {
                                    from {
                                        opacity: 0;
                                        transform: translateY(30px);
                                    }
                                    to {
                                        opacity: 1;
                                        transform: translateY(0);
                                    }
                                }

                                .hero-title {
                                    font-size: 56px;
                                    font-weight: 700;
                                    margin-bottom: 25px;
                                    line-height: 1.2;
                                    letter-spacing: -1px;
                                    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                                }

                                .hero-title span {
                                    color: #4A90E2;
                                    text-decoration: none;
                                    position: relative;
                                    font-weight: 800;
                                }

                                .hero-title span::after {
                                    content: '';
                                    position: absolute;
                                    bottom: -4px;
                                    left: 0;
                                    right: 0;
                                    height: 3px;
                                    background: #4A90E2;
                                    transform: scaleX(0.8);
                                }

                                .hero-subtitle {
                                    font-size: 24px;
                                    opacity: 0.95;
                                    margin-bottom: 20px;
                                    font-weight: 300;
                                    letter-spacing: 0.5px;
                                }

                                .hero-description {
                                    font-size: 18px;
                                    opacity: 0.85;
                                    margin-bottom: 35px;
                                    line-height: 1.6;
                                    max-width: 700px;
                                    margin-left: auto;
                                    margin-right: auto;
                                }

                                .hero-button {
                                    background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
                                    color: white;
                                    border: none;
                                    padding: 16px 45px;
                                    font-size: 18px;
                                    border-radius: 50px;
                                    cursor: pointer;
                                    transition: all 0.3s;
                                    font-weight: 600;
                                    letter-spacing: 0.5px;
                                    box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
                                    margin: 0 10px;
                                    display: inline-block;
                                }

                                .hero-button:hover {
                                    background: linear-gradient(135deg, #357ABD 0%, #2968A8 100%);
                                    transform: translateY(-2px);
                                    box-shadow: 0 6px 25px rgba(74, 144, 226, 0.4);
                                }

                                .hero-button-secondary {
                                    background: transparent;
                                    color: white;
                                    border: 2px solid white;
                                    padding: 14px 40px;
                                    font-size: 18px;
                                    border-radius: 50px;
                                    cursor: pointer;
                                    transition: all 0.3s;
                                    font-weight: 600;
                                    letter-spacing: 0.5px;
                                    margin: 0 10px;
                                    display: inline-block;
                                }

                                .hero-button-secondary:hover {
                                    background: white;
                                    color: #1a1a1a;
                                    transform: translateY(-2px);
                                    box-shadow: 0 6px 25px rgba(255, 255, 255, 0.2);
                                }

                                /* Services Section */
                                .services-section {
                                    padding: 80px 20px;
                                    background: #f8f9fa;
                                }

                                .services-section h2 {
                                    text-align: center;
                                    font-size: 36px;
                                    margin-bottom: 20px;
                                    color: #1a1a1a;
                                }

                                .section-subtitle {
                                    text-align: center;
                                    color: #666;
                                    margin-bottom: 50px;
                                }

                                .services-grid {
                                    display: grid;
                                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                                    gap: 30px;
                                    margin-top: 40px;
                                }

                                .service-item {
                                    background: white;
                                    padding: 30px;
                                    border-radius: 10px;
                                    text-align: center;
                                    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
                                    transition: transform 0.3s;
                                }

                                .service-item:hover {
                                    transform: translateY(-5px);
                                    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
                                }

                                .service-item i {
                                    font-size: 40px;
                                    color: #007cba;
                                    margin-bottom: 15px;
                                }

                                /* About & Team Section */
                                .about-section {
                                    padding: 80px 20px;
                                    background: white;
                                }

                                .about-section h2 {
                                    font-size: 36px;
                                    margin-bottom: 20px;
                                    color: #1a1a1a;
                                    text-align: center;
                                }

                                .about-section .section-subtitle {
                                    text-align: center;
                                    color: #666;
                                    font-size: 20px;
                                    margin-bottom: 40px;
                                }

                                .about-content {
                                    font-size: 18px;
                                    line-height: 1.8;
                                    color: #555;
                                    margin-bottom: 50px;
                                }

                                /* Team Grid */
                                .team-grid {
                                    display: grid;
                                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                                    gap: 40px;
                                    margin-top: 50px;
                                }

                                .team-member {
                                    text-align: center;
                                    padding: 30px;
                                    background: #f8f9fa;
                                    border-radius: 10px;
                                    transition: transform 0.3s, box-shadow 0.3s;
                                }

                                .team-member:hover {
                                    transform: translateY(-5px);
                                    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                                }

                                .team-member img {
                                    width: 150px;
                                    height: 150px;
                                    border-radius: 50%;
                                    object-fit: cover;
                                    margin-bottom: 20px;
                                }

                                .member-placeholder {
                                    width: 150px;
                                    height: 150px;
                                    border-radius: 50%;
                                    background: #e0e0e0;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    margin: 0 auto 20px;
                                    font-size: 80px;
                                    color: #999;
                                }

                                .team-member h3 {
                                    font-size: 24px;
                                    margin-bottom: 10px;
                                    color: #1a1a1a;
                                }

                                .member-role {
                                    font-size: 16px;
                                    color: #007cba;
                                    font-weight: 500;
                                    margin-bottom: 15px;
                                }

                                .member-bio {
                                    font-size: 14px;
                                    line-height: 1.6;
                                    color: #666;
                                    text-align: left;
                                }

                                /* Contact Section */
                                .contact-section {
                                    padding: 80px 20px;
                                    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                                }

                                .contact-section h2 {
                                    text-align: center;
                                    font-size: 36px;
                                    margin-bottom: 40px;
                                }

                                .contact-grid {
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 50px;
                                    max-width: 900px;
                                    margin: 0 auto;
                                }

                                .contact-form {
                                    display: flex;
                                    flex-direction: column;
                                    gap: 15px;
                                }

                                .contact-form input,
                                .contact-form textarea {
                                    padding: 12px;
                                    border: 1px solid #ddd;
                                    border-radius: 5px;
                                    font-size: 16px;
                                }

                                .contact-form textarea {
                                    min-height: 120px;
                                }

                                .contact-form button {
                                    background: #007cba;
                                    color: white;
                                    border: none;
                                    padding: 12px 30px;
                                    border-radius: 5px;
                                    font-size: 16px;
                                    cursor: pointer;
                                    transition: background 0.3s;
                                }

                                .contact-form button:hover {
                                    background: #005a87;
                                }

                                .contact-info p {
                                    margin-bottom: 15px;
                                    display: flex;
                                    align-items: center;
                                    gap: 10px;
                                    font-size: 16px;
                                }

                                .contact-info i {
                                    color: #007cba;
                                    width: 20px;
                                }

                                /* CTA Section */
                                .cta-section {
                                    padding: 80px 20px;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    text-align: center;
                                }

                                .cta-section h2 {
                                    font-size: 36px;
                                    margin-bottom: 20px;
                                }

                                .cta-section p {
                                    font-size: 18px;
                                    margin-bottom: 30px;
                                    opacity: 0.9;
                                }

                                .cta-button {
                                    background: white;
                                    color: #667eea;
                                    border: none;
                                    padding: 15px 40px;
                                    font-size: 18px;
                                    border-radius: 5px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    transition: all 0.3s;
                                }

                                .cta-button:hover {
                                    transform: translateY(-2px);
                                    box-shadow: 0 5px 20px rgba(255,255,255,0.3);
                                }

                                /* Generic Section */
                                .generic-section {
                                    padding: 80px 20px;
                                    background: white;
                                }

                                .generic-section .section-title {
                                    font-size: 36px;
                                    margin-bottom: 20px;
                                    color: #1a1a1a;
                                    text-align: center;
                                }

                                .generic-section .section-subtitle {
                                    font-size: 20px;
                                    color: #666;
                                    margin-bottom: 30px;
                                    text-align: center;
                                }

                                .generic-section .content {
                                    font-size: 16px;
                                    line-height: 1.8;
                                    color: #555;
                                    margin-bottom: 30px;
                                    max-width: 900px;
                                    margin-left: auto;
                                    margin-right: auto;
                                }

                                /* Additional Fields Display */
                                .additional-fields {
                                    background: #f8f9fa;
                                    border-radius: 10px;
                                    padding: 30px;
                                    margin: 40px auto;
                                    max-width: 900px;
                                }

                                .field-item {
                                    margin-bottom: 20px;
                                    padding-bottom: 20px;
                                    border-bottom: 1px solid #e0e0e0;
                                }

                                .field-item:last-child {
                                    border-bottom: none;
                                    margin-bottom: 0;
                                    padding-bottom: 0;
                                }

                                .field-item strong {
                                    color: #333;
                                    font-size: 14px;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    display: inline-block;
                                    margin-bottom: 8px;
                                }

                                .field-item span {
                                    color: #555;
                                    font-size: 16px;
                                }

                                .field-item .long-text {
                                    margin-top: 10px;
                                    line-height: 1.6;
                                    color: #555;
                                    font-size: 15px;
                                }

                                .generic-section .primary-button {
                                    background: #007cba;
                                    color: white;
                                    border: none;
                                    padding: 14px 35px;
                                    border-radius: 5px;
                                    font-size: 16px;
                                    cursor: pointer;
                                    transition: all 0.3s;
                                    font-weight: 600;
                                }

                                .generic-section .primary-button:hover {
                                    background: #005a87;
                                    transform: translateY(-2px);
                                    box-shadow: 0 4px 15px rgba(0,124,186,0.3);
                                }

                                .buttons-container {
                                    text-align: center;
                                }

                                @media (max-width: 768px) {
                                    .hero-title { font-size: 32px; }
                                    .contact-grid { grid-template-columns: 1fr; }
                                    .services-grid { grid-template-columns: 1fr; }
                                }

                                /* RTL Support */
                                [dir="rtl"] {
                                    text-align: right;
                                }

                                [dir="rtl"] .contact-info p {
                                    flex-direction: row-reverse;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="preview-header">
                                <h3>Visual Preview: ${section.name}</h3>
                                <div class="preview-info">
                                    ${currentLang === 'he' ? 'Hebrew' : 'English'} Version |
                                    ${section.visible ? 'Currently Live' : 'Currently Hidden'} |
                                    ${currentPage === 'index' ? 'Homepage' : currentPage}
                                </div>
                            </div>
                            ${sectionHTML}
                        </body>
                    </html>
                `);
            }
        }

        function searchSections() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const sectionCards = document.querySelectorAll('.section-card');
            let visibleCount = 0;
            let hiddenMatchCount = 0;

            sectionCards.forEach(card => {
                const sectionId = card.id.replace('section-', '');
                const section = sections.find(s => s.id === sectionId);

                if (!section) return;

                let isMatch = false;

                if (searchTerm === '') {
                    isMatch = true;
                } else {
                    // Search in section name
                    if (section.name.toLowerCase().includes(searchTerm)) {
                        isMatch = true;
                    }

                    // Search in content
                    if (!isMatch) {
                        Object.values(section.content).forEach(value => {
                            if (value && value.toString().toLowerCase().includes(searchTerm)) {
                                isMatch = true;
                            }
                        });
                    }
                }

                if (isMatch) {
                    card.classList.remove('search-hidden');
                    visibleCount++;

                    if (!section.visible) {
                        hiddenMatchCount++;
                    }
                } else {
                    card.classList.add('search-hidden');
                }
            });

            updateSearchResults(visibleCount, sections.length, hiddenMatchCount);
        }

        function updateSearchResults(visible, total, hiddenCount = 0) {
            const resultsDiv = document.getElementById('searchResults');
            let icon = 'fa-info-circle';
            let message = '';

            if (visible === total) {
                const hiddenSections = sections.filter(s => !s.visible).length;
                icon = 'fa-check-circle';
                if (hiddenSections > 0) {
                    message = `Showing all ${total} sections (${hiddenSections} are hidden from website)`;
                } else {
                    message = `Showing all ${total} sections`;
                }
            } else if (visible === 0) {
                icon = 'fa-exclamation-circle';
                message = `No sections match your search`;
            } else {
                icon = 'fa-search';
                if (hiddenCount > 0) {
                    message = `Found ${visible} of ${total} sections (${hiddenCount} are hidden from website)`;
                } else {
                    message = `Found ${visible} of ${total} sections`;
                }
            }

            resultsDiv.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 's') {
                    e.preventDefault();
                    if (unsavedChanges) {
                        saveAllSections();
                    }
                } else if (e.key === 'f') {
                    e.preventDefault();
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput && !searchInput.classList.contains('hidden')) {
                        searchInput.focus();
                    }
                }
            }
        });

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (unsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Add pulse animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.02); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>